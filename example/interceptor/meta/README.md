# Meta interceptor
In this example, we will try to create GoFrame server meta interceptor enabled.

Meta interceptor will send bellow headers to client by default.

| Header key | Description |
| ---- | ---- |
| X-Request-Id | Request id generated by the interceptor. |
| X-[Prefix]-App | Application name. |
| X-[Prefix]-App-Version | Version of application. |
| X-[Prefix]-App-Unix-Time | Unix time of current application. |
| X-[Prefix]-Request-Received-Time | Time of current request received by application. |

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
**Table of Contents**  *generated with [DocToc](https://github.com/thlorenz/doctoc)*

- [Quick start](#quick-start)
  - [Code](#code)
- [Options](#options)
  - [Context Usage](#context-usage)
- [Override RequestId](#override-requestid)
- [Override AppName and AppVersion](#override-appname-and-appversion)
- [Example](#example)
    - [Start server](#start-server)
    - [Output](#output)
    - [Code](#code-1)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

## Quick start
Get rk-gf package from the remote repository.

```go
go get -u github.com/rookie-ninja/rk-gf
```

### Code
Add rkgfmeta.Interceptor() meta with option.

```go
import     "github.com/rookie-ninja/rk-gf/interceptor/meta"
```
```go
    // ********************************************
    // ********** Enable interceptors *************
    // ********************************************
	interceptors := []ghttp.HandlerFunc{
        rkgfmeta.Interceptor(),
    }
```

## Options
Meta interceptor is only available on server side. The interceptor will send bellow headers back to client.

- X-Request-Id: Generated by [rkcommon.GenerateRequestId()](https://github.com/rookie-ninja/rk-common/blob/master/common/common.go)
- X-RK-App-Name: Retrieved from [rkentry.GlobalAppCtx.GetAppInfoEntry().AppName](https://github.com/rookie-ninja/rk-entry#appinfoentry)
- X-RK-App-Version: Retrieved from [rkentry.GlobalAppCtx.GetAppInfoEntry().Version](https://github.com/rookie-ninja/rk-entry#appinfoentry)
- X-RK-Unix-Time: Server time when request arrives.
- X-RK-Received-Time: Server time when request arrives.

![arch](img/arch.png)

| Name | Description | Default Values |
| ---- | ---- | ---- |
| rkgfmeta.WithEntryNameAndType(entryName, entryType string) | Provide entry name and type if there are multiple meta interceptors needs to be used. | gf, gf |
| rkgfmeta.WithPrefix(prefix string) | Provide prefix of meta header | RK |

```go
    // ********************************************
    // ********** Enable interceptors *************
    // ********************************************
	interceptors := []ghttp.HandlerFunc{
        rkgfmeta.Interceptor(
            // Entry name and entry type will be used for distinguishing interceptors. Recommended.
            // rkgfmeta.WithEntryNameAndType("greeter", "gf"),
            //
            // We will replace X-<Prefix>-XXX with prefix user provided.
            // rkgfmeta.WithPrefix("Dog"),
        ),
    }
```
```shell script
# Print out headers from server on client side.
< X-Request-Id: 861adbd1-6b98-446b-8fa0-3699a37bd7f1
< X-Rk-App-Name: rk
< X-Rk-App-Unix-Time: 2021-06-24T21:29:24.877293+08:00
< X-Rk-App-Version: v0.0.0
< X-Rk-Received-Time: 2021-06-24T21:29:24.877293+08:00
```

### Context Usage
| Name | Functionality |
| ------ | ------ |
| rkgfctx.GetLogger(*ghttp.Request) | Get logger generated by log interceptor. If there are X-Request-Id or X-Trace-Id as headers in incoming and outgoing metadata, then loggers will has requestId and traceId attached by default. |
| rkgfctx.GetEvent(*ghttp.Request) | Get event generated by log interceptor. Event would be printed as soon as RPC finished. |
| rkgfctx.GetIncomingHeaders(*ghttp.Request) | Get incoming header. |
| rkgfctx.AddHeaderToClient(ctx, "k", "v") | Add k/v to headers which would be sent to client. This is append operation. |
| rkgfctx.SetHeaderToClient(ctx, "k", "v") | Set k/v to headers which would be sent to client. |

## Override RequestId
In this example, we will try to override X-Request-Id header with our own. We will send both auto generated requestId and user
requestId to client.

Otherwise, if log interceptor was enabled, we will pick the latest one and attach to event logger and zap logger.

```go
    rkgfctx.SetHeaderToClient(ctx, rkgfctx.RequestIdKey, "this-is-my-request-id-overridden")
```

```shell script
# Headers sent from server.
< X-Request-Id: this-is-my-request-id-overridden
< X-Rk-App-Name: rk
< X-Rk-App-Unix-Time: 2021-06-24T21:38:33.561189+08:00
< X-Rk-App-Version: v0.0.0
< X-Rk-Received-Time: 2021-06-24T21:38:33.561189+08:00
```
```shell script
# Event logger
------------------------------------------------------------------------
endTime=2021-06-24T21:38:33.561353+08:00
startTime=2021-06-24T21:38:33.561172+08:00
elapsedNano=181218
timezone=CST
ids={"eventId":"this-is-my-request-id-overridden","requestId":"this-is-my-request-id-overridden"}
app={"appName":"rk","appVersion":"v0.0.0","entryName":"gf","entryType":"gf"}
env={"arch":"amd64","az":"*","domain":"*","hostname":"lark.local","localIP":"10.8.0.2","os":"darwin","realm":"*","region":"*"}
payloads={"apiMethod":"GET","apiPath":"/rk/v1/greeter","apiProtocol":"HTTP/1.1","apiQuery":"name=rk-dev","userAgent":"curl/7.64.1"}
error={}
counters={}
pairs={}
timing={}
remoteAddr=localhost:52206
operation=/rk/v1/greeter
resCode=200
eventStatus=Ended
EOE
```

## Override AppName and AppVersion
AppName and AppVersion was retrieved from [rkentry.GlobalAppCtx.GetAppInfoEntry().AppName](https://github.com/rookie-ninja/rk-entry#appinfoentry) and [rkentry.GlobalAppCtx.GetAppInfoEntry().Version](https://github.com/rookie-ninja/rk-entry#appinfoentry).

Override it before GoFrame server starts.

```go
func main() {
    ...
    // 0: Override AppName and AppVersion
    rkentry.GlobalAppCtx.GetAppInfoEntry().AppName = "demo-app"
    rkentry.GlobalAppCtx.GetAppInfoEntry().Version = "demo-version"

    // 1: Create gf server
    server := startGreeterServer(opts...)
    ...
}
```

```shell script
# Headers sent from server
< X-Request-Id: 48bcce4d-d828-42a6-a836-f699c1268ace
< X-Rk-App-Name: demo-app
< X-Rk-App-Unix-Time: 2021-06-24T21:41:27.807217+08:00
< X-Rk-App-Version: demo-version
< X-Rk-Received-Time: 2021-06-24T21:41:27.807217+08:00
```

## Example
In this example, we enable log interceptor either to monitor RPC status.

#### Start server
```shell script
$ go run greeter-server.go
```

#### Output
- Server side (zap & event)
```shell script
2021-06-24T21:43:18.959+0800    INFO    meta/greeter-server.go:84       Received request from client.   {"requestId": "6696cfbd-0060-4318-a564-75fa71415f0a"}
```
```shell script
------------------------------------------------------------------------
endTime=2021-06-24T21:43:18.960052+08:00
startTime=2021-06-24T21:43:18.959886+08:00
elapsedNano=165739
timezone=CST
ids={"eventId":"6696cfbd-0060-4318-a564-75fa71415f0a","requestId":"6696cfbd-0060-4318-a564-75fa71415f0a"}
app={"appName":"rk","appVersion":"v0.0.0","entryName":"gf","entryType":"gf"}
env={"arch":"amd64","az":"*","domain":"*","hostname":"lark.local","localIP":"10.8.0.2","os":"darwin","realm":"*","region":"*"}
payloads={"apiMethod":"GET","apiPath":"/rk/v1/greeter","apiProtocol":"HTTP/1.1","apiQuery":"name=rk-dev","userAgent":"curl/7.64.1"}
error={}
counters={}
pairs={}
timing={}
remoteAddr=localhost:53396
operation=/rk/v1/greeter
resCode=200
eventStatus=Ended
EOE
```

- Client side
```shell script
$ curl -vs "localhost:8080/rk/v1/greeter?name=rk-dev"
...
< HTTP/1.1 200 OK
< Content-Type: application/json; charset=utf-8
< X-Request-Id: 6696cfbd-0060-4318-a564-75fa71415f0a
< X-Rk-App-Name: rk
< X-Rk-App-Unix-Time: 2021-06-24T21:43:18.959902+08:00
< X-Rk-App-Version: v0.0.0
< X-Rk-Received-Time: 2021-06-24T21:43:18.959902+08:00
...
{"Message":"Hello rk-dev!"}
```

#### Code
- [greeter-server.go](greeter-server.go)
